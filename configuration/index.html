<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Vault KMS Provider</title>
        <link rel="stylesheet" href="/css/index.css">
        <link rel="apple-touch-icon" sizes="180x180" href="https://vault-kms-provider.io/assets/apple-touch-icon.png">
        <link rel="icon" href="https://vault-kms-provider.io/assets/favicon.ico">
        <link rel="icon" type="image/png" sizes="32x32" href="https://vault-kms-provider.io/assets/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://vault-kms-provider.io/assets/favicon-16x16.png">
        <link rel="manifest" href="https://vault-kms-provider.io/assets/site.webmanifest">
        <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
        <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-solarizedlight.css" rel="stylesheet"/>
    </head>
    <body style="background-color: #ffffff">
        <div class = "github-link">
            <a href="https://github.com/Ruddickmg/vault-kms-provider">
                <img src="https://vault-kms-provider.io/assets/github-mark.png" alt="GitHub" class="github-icon" />
            </a>
        </div>
        
<div class="homepage">
    <div class="sidebar">
       <div class="navbar">
           <div>
             <a href="/">
               <h2>About</h2>
             </a>
           </div>
           <div>
             <a href="/quick-start">
               <h2>Quick Start</h2>
             </a>
           </div>
           
               
                   
               
           
               
                   
               
           
               
                   
               
           
               
                   
               
           
               
                   
                   <div>
                     
                       <h2>Benchmarks</h2>
                     
                     <ul>
                       
                         <li><a href=/benchmarks/health/>Health</a></li>
                       
                         <li><a href=/benchmarks/decryption/>Decryption</a></li>
                       
                         <li><a href=/benchmarks/encryption/>Encryption</a></li>
                       
                     </ul>
                   </div>
                   
               
           
               
                   
                   <div>
                     
                       <a href="/installation"><h2>Installation</h2></a>
                     
                     <ul>
                       
                         <li><a href=/installation/docker/>Docker</a></li>
                       
                         <li><a href=/installation/helm/>Helm</a></li>
                       
                         <li><a href=/installation/repository/>Repository</a></li>
                       
                         <li><a href=/installation/static/>Static</a></li>
                       
                     </ul>
                   </div>
                   
               
           
               
                   
               
           
               
                   
                   <div>
                     
                       <a href="/configuration"><h2>Configuration</h2></a>
                     
                     <ul>
                       
                         <li><a href=/configuration/authentication/>Authentication</a></li>
                       
                         <li><a href=/configuration/kubernetes/>Kubernetes</a></li>
                       
                         <li><a href=/configuration/plugin/>Plugin</a></li>
                       
                         <li><a href=/configuration/tls/>Tls</a></li>
                       
                         <li><a href=/configuration/vault/>Vault</a></li>
                       
                     </ul>
                   </div>
                   
               
           
       </div>
    </div>
    <div class="content">
        
<div class="content-header">
    <h1>Configuration</h1>
</div>
<div class="content-body">
    

<h2>Authentication</h2>
<p>Currently, the following authentication methods are supported</p>
<ul>
<li><a href="https://developer.hashicorp.com/vault/api-docs/auth/token">Token</a></li>
<li><a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes">Kubernetes</a></li>
<li><a href="https://developer.hashicorp.com/vault/docs/auth/userpass">UserPass</a></li>
<li><a href="https://developer.hashicorp.com/vault/docs/auth/approle">AppRole</a></li>
<li><a href="https://developer.hashicorp.com/vault/docs/auth/jwt">JWT/OIDC</a></li>
<li><a href="https://developer.hashicorp.com/vault/docs/auth/cert">Certificate</a></li>
</ul>
<p>Configuration of auth methods is done using the environment variables listed below.</p>
<pre class="language-hcl"><code class="language-hcl"># Path defined for the authentication route, ex: auth/custom-auth-path/...
#  if not set, will default to the associated auth method, ex: auth/userpass/.. or auth/kubernetes/..
VAULT_AUTH_MOUNT = "custom-auth-path"

# Vault token for vault access
VAULT_TOKEN = "SiQOECxwSDCeQt1r0n5kqQCr"
# path to file containing vault token
VAULT_TOKEN_PATH = "/path/to/vault/token"

# user and password for userpass authentication
VAULT_USER = "vault-kms-provider"
VAULT_PASSWORD = "some-password"
# path to file containing vault password
VAULT_PASSWORD_PATH = "/path/to/vault/password"

# path to mounted JWT for kubernetes auth
VAULT_KUBERNETES_JWT_PATH = "/path/to/vault.jwt"
# jwt for kubernetes auth
VAULT_KUBERNETES_JWT = "jwt"
# role for kubernetes auth 
VAULT_KUBERNETES_ROLE = "vault-kms-provider"

# role_id and secret_id for approle authentication
VAULT_ROLE_ID = "role"
VAULT_SECRET_ID = "secret"
# path to file containing secret id
VAULT_SECRET_ID_PATH = "/path/to/secret/id"

# jwt for jwt auth
VAULT_JWT = "jwt"
# path to mounted jwt for jwt auth
VAULT_JWT_PATH = "/path/to/jwt"
# role for jwt, optional
VAULT_JWT_ROLE = "vault-kms-provider"

# name of the trusted certificate created in vault for authentication
VAULT_CERTIFICATE_NAME = "vault-kms-provider"
# path to client cert and key for certificate authentication
VAULT_CLIENT_CERT = "/path/to/client/public.crt"
VAULT_CLIENT_KEY = "/path/to/client/private.key"</code></pre>
<p>Environment variables can be configured using the <code>env</code> property in the values.yaml, ex:</p>
<pre class="language-yaml"><code class="language-yaml">env:
  - name: VAULT_TOKEN
    valueFrom:
      secretKeyRef:
        name: vault-token-secret
        key: token</code></pre>
<p>The <code>envFrom</code> property is also configurable in the values.yaml file, allowing configMaps, etc to be added. ex:</p>
<pre class="language-yaml"><code class="language-yaml">envFrom:
  - configMapRef:
    name: my-custom-config-map</code></pre>


<h2>Configure Kubernetes</h2>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>Kubernetes documentation on setting up encryption can be found <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#use-the-new-encryption-configuration-file">here</a></p>
</div>
<p>Create an encryption configuration for the Kubernetes api server</p>
<p><code>./encryption-configuration.yaml</code></p>
<pre class="language-yaml"><code class="language-yaml">apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - kms:
          apiVersion: v2
          name: vault-kms-provider
          endpoint: unix:///mnt/vault-kms-provider.sock
          timeout: 3s
      - identity: {}</code></pre>
<p>Point the api server to your encryption configuration</p>
<p><code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<pre class="language-yaml"><code class="language-yaml"># add these commands to your Kubernetes api server configuration
spec:
  containers:
    - command:
        - kube-apiserver
        # Point to your encryption file
        - --encryption-provider-config="/path/to/your/encryption-configuration.yaml"</code></pre>
<p>This is done in differently in some flavors of kubernetes, if yours is different, consult the documentation of your Kubernetes distro for instructions on how to point Kubernetes to your configuration file.</p>


<h2>Plugin</h2>
<h3>Helm values</h3>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>You can reference the helm <a href="https://github.com/Ruddickmg/vault-kms-provider/blob/main/helm/values.yaml">values.yaml</a> for a full list of configurations</p>
</div>
<p>When deploying via helm, it is important to ensure that the <code>vault.address</code> is set correctly.</p>
<pre class="language-shell"><code class="language-shell">helm install vault-kms-provider --set "vault.address=https://vault.default.svc.cluster.local:8200"</code></pre>
<p>Depending on the type of authentication you require you may want to disable the service account.</p>
<pre class="language-shell"><code class="language-shell">helm install vault-kms-provider --set "serviceAccount.create=false"</code></pre>
<h3>Environment variables</h3>
<p>Below are some general environment variables and their defaults for configuration of the KMS provider</p>
<pre class="language-hcl"><code class="language-hcl"># Url of the vault service
VAULT_ADDRESS = "https://vault.vault.svc.cluster.local:8200"

# The endpoint that the health checks will listen on
HEALTH_ENDPOINT = "0.0.0.0:8080"

# Path to the socket used for communication with the Kubernetes API server. Can be either abstract (@path/to/abstract.sock) or file path.
# Abstract socket paths must be prefixed with the "@" symbol
SOCKET_PATH = "./sockets/vault-kms-provider.sock"

# The level of permissions granted to the socket (does not apply to abstract sockets)
SOCKET_PERMISSIONS = "666"

# The string identifier used to store the encryption keys in the vault transit gateway
VAULT_TRANSIT_KEY = "vault-kms-provider"

# path defined for the transit gateway, ex: auth/transit/... or auth/transit-path/...
VAULT_TRANSIT_MOUNT = "transit"</code></pre>


<h2>Set up TLS communication</h2>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>Documentation on TLS configuration for vault can be <a href="https://developer.hashicorp.com/vault/docs/configuration/listener/tcp">found on their website</a></p>
</div>
<h3>Add Vault's CA file(s) to the KMS provider</h3>
<p>To allow TLS encrypted communication with vault, Vault's CA (certificate authority) file(s) need to be installed in the KMS provider. This can be set in the values.yaml for the helm chart.</p>
<pre class="language-yaml"><code class="language-yaml">vault:
  ca:
    # full path to a specific CA file
    file: "/path/to/ca.crt"
    # full path to a directory containing CA file(s)
    directory: "/path/to/ca/directory"</code></pre>
<p>If you have a single CA file for vault, you can set a specific path to it.</p>
<pre class="language-shell"><code class="language-shell">helm install vault-kms-provider --set "vault.ca.file=/path/to/ca.crt"</code></pre>
<p>If you have more than one file, or would rather just point to a directory, you can also specify a directory path. All certificates in the directory path will be installed in the KMS provider.</p>
<pre class="language-shell"><code class="language-shell">helm install vault-kms-provider --set "vault.ca.directory=/path/to/directory"</code></pre>
<h3>Mount Vault's CA files into the KMS provider</h3>
<p>In order for Vault's CA files to be installed, they must be present in the container, we can mount the CA file(s) by defining volumes and volumeMounts in our values.yaml.</p>
<p>The following are examples of how to mount Vault CA file(s) into the KMS provider.</p>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>A full list of <a href="https://kubernetes.io/docs/concepts/storage/volumes/">mount options and documentation</a> can be found on the Kubernetes website. Chose what works best for your use case.</p>
</div>
<h4>Secrets</h4>
<pre class="language-yaml"><code class="language-yaml">volumes:
  # name of the volume, should match the volumeMount name
  - name: vault-ca-certificate
    secret:
      # The name of the secret that contains the Vault CA certificate(s)
      secretName: vault-ca-certs

volumeMounts:
  # Match with volume name
  - name: vault-ca-certificate
    # path where the files will be in the KMS provider
    mountPath: /etc/ssl/certs</code></pre>
<h4>Volumes</h4>
<pre class="language-yaml"><code class="language-yaml">volumes:
  # name of the volume, should match the volumeMount name
  - name: vault-ca-certificates
    hostPath:
      # Path to the directory where the Vault CA certificate(s) are located on the host machine
      path: /path/to/host/certificates
      type: Directory

volumeMounts:
  # Match with volume name
  - name: vault-ca-certificate
    # path where the files will be in the KMS provider
    mountPath: /etc/ssl/certs</code></pre>


<h2>Set up Vault</h2>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>The Vault KMS Provider will use any transit key found at the default or user specified transit path, if no key is found the provider will initialize one with Vault transits default key type (<a href="https://developer.hashicorp.com/vault/api-docs/secret/transit#aes256-gcm96">aes256-gcm96</a>).</p>
<p>See <a href="https://developer.hashicorp.com/vault/api-docs/secret/transit#create-key">Vault documentation</a> for creating keys.</p>
</div>
<h3>Encryption</h3>
<p>Enable the transit gateway in Vault for encryption/decryption of data for Kubernetes.</p>
<pre class="language-shell"><code class="language-shell">vault secrets enable transit</code></pre>
<p>Create a policy granting the permissions to the KMS provider to encrypt/decrypt data.</p>
<p><code>./transit.hcl</code></p>
<pre class="language-hcl"><code class="language-hcl">path "/transit/decrypt/vault-kms-provider" {
  capabilities = ["update", "create"]
}
path "/transit/encrypt/vault-kms-provider" {
  capabilities = ["update", "create"]
}
path "/transit/keys/vault-kms-provider" {
  capabilities = ["read"]
}</code></pre>
<p>Add the policy to vault</p>
<pre class="language-shell"><code class="language-shell">vault policy write vault-kms-provider transit.hcl</code></pre>
<h3>Authentication</h3>
<p>Enable authentication via kubernetes</p>
<pre class="language-shell"><code class="language-shell">vault auth enable kubernetes</code></pre>
<p>Set the host URL to the kubernetes API</p>
<pre class="language-shell"><code class="language-shell">vault write auth/kubernetes/config kubernetes_host="https://kubernetes.default.svc/"</code></pre>
<p>Create a role for the KMS provider's service account so that it can authenticate with vault.</p>
<pre class="language-shell"><code class="language-shell">vault write auth/kubernetes/role/vault-kms-provider \
    bound_service_account_names=vault-kms-provider \
    bound_service_account_namespaces=default \
    audience=vault \
    token_policies=vault-kms-provider \
    ttl=1h</code></pre>
<p>With vault configured you should be able to deploy the vault-kms-provider to kubernetes without error.</p>


</div>

    </div>
</div>
    </body>
</html>
