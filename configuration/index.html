<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Vault KMS Provider</title>
        <link rel="stylesheet" href="/css/index.css">
        <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
        <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-solarizedlight.css" rel="stylesheet"/>
    </head>
    <body style="background-color: #ffffff">
        
<div class="homepage">
    <div class="sidebar">
       <div class="navbar">
           <div>
             <a href="/">
               <h2>Quick Start</h2>
             </a>
           </div>
           
               
                   
               
           
               
                   
                   <div>
                     
                       <a href="/configuration"><h2>Configuration</h2></a>
                     
                     <ul>
                       
                         <li><a href=/configuration/kubernetes/>Kubernetes</a></li>
                       
                         <li><a href=/configuration/provider/>Provider</a></li>
                       
                         <li><a href=/configuration/tls/>Tls</a></li>
                       
                         <li><a href=/configuration/vault/>Vault</a></li>
                       
                     </ul>
                   </div>
                   
               
           
               
                   
               
           
               
                   
                   <div>
                     
                       <a href="/installation"><h2>Installation</h2></a>
                     
                     <ul>
                       
                         <li><a href=/installation/docker/>Docker</a></li>
                       
                         <li><a href=/installation/helm/>Helm</a></li>
                       
                         <li><a href=/installation/repository/>Repository</a></li>
                       
                     </ul>
                   </div>
                   
               
           
               
                   
                   <div>
                     
                       <h2>Benchmarks</h2>
                     
                     <ul>
                       
                         <li><a href=/benchmarks/encryption/>Encryption</a></li>
                       
                         <li><a href=/benchmarks/health/>Health</a></li>
                       
                         <li><a href=/benchmarks/decryption/>Decryption</a></li>
                       
                     </ul>
                   </div>
                   
               
           
       </div>
    </div>
    <div class="content">
        
<div class="content-header">
    <h1>Configuration</h1>
</div>
<div class="content-body">
    

<h2>Configure Kubernetes</h2>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>Kubernetes documentation on setting up encryption can be found <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#use-the-new-encryption-configuration-file">here</a></p>
</div>
<p>Create an encryption configuration for the Kubernetes api server</p>
<p><code>./encryption-configuration.yaml</code></p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiserver.config.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> EncryptionConfiguration
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> secrets
    <span class="token key atrule">providers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">kms</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v2
          <span class="token key atrule">name</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>kms<span class="token punctuation">-</span>provider
          <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///mnt/vault<span class="token punctuation">-</span>kms<span class="token punctuation">-</span>provider.sock
          <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 3s
      <span class="token punctuation">-</span> <span class="token key atrule">identity</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>Point the api server to your encryption configuration</p>
<p><code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<pre class="language-yaml"><code class="language-yaml"><span class="token comment"># add these commands to your Kubernetes api server configuration</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>apiserver
        <span class="token comment"># Point to your encryption file</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>encryption<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>config="/path/to/your/encryption<span class="token punctuation">-</span>configuration.yaml"</code></pre>
<p>This is done in differently in some flavors of kubernetes, if yours is different, consult the documentation of your Kubernetes distro for instructions on how to point Kubernetes to your configuration file.</p>


<h2>Provider</h2>
<h3>Helm values</h3>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>You can reference the helm <a href="https://github.com/Ruddickmg/vault-kms-provider/blob/main/helm/values.yaml">values.yaml</a> for a full list of configurations</p>
</div>
<p>When deploying via helm, it is important to ensure that the <code>vault.address</code> is set correctly.</p>
<pre class="language-shell"><code class="language-shell">helm <span class="token function">install</span> vault-kms-provider <span class="token parameter variable">--set</span> <span class="token string">"vault.address=https://vault.default.svc.cluster.local:8200"</span></code></pre>
<p>Depending on the type of authentication you require you may want to disable the service account.</p>
<pre class="language-shell"><code class="language-shell">helm <span class="token function">install</span> vault-kms-provider <span class="token parameter variable">--set</span> <span class="token string">"serviceAccount.create=false"</span></code></pre>
<h3>Environment variables</h3>
<p>Below are all the environment variables and their defaults for configuration of the KMS provider</p>
<pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Url of the vault service</span>
<span class="token property">VAULT_ADDRESS</span> <span class="token punctuation">=</span> <span class="token string">"https://vault.vault.svc.cluster.local:8200"</span>

<span class="token comment"># Path to the socket used for communication with the Kubernetes API server</span>
<span class="token property">SOCKET_PATH</span> <span class="token punctuation">=</span> <span class="token string">"./sockets/vault-kms-provider.sock"</span>

<span class="token comment"># The level of permissions granted to the socket, choices are:</span>
<span class="token comment">#   - any: equivalent to 666</span>
<span class="token comment">#   - user: equivalent to 600</span>
<span class="token comment">#   - group: equivalent to 660</span>
<span class="token property">SOCKET_PERMISSIONS</span> <span class="token punctuation">=</span> <span class="token string">"any"</span>

<span class="token comment"># The string identifier used to store the encryption keys in the vault transit gateway</span>
<span class="token property">VAULT_TRANSIT_KEY</span> <span class="token punctuation">=</span> <span class="token string">"vault-kms-provider"</span>

<span class="token comment"># Used for authenticating with vault, only use if token authentication is desired.</span>
<span class="token property">VAULT_TOKEN</span> <span class="token punctuation">=</span> <span class="token string">""</span>

<span class="token comment"># The endpoint that the health checks will listen on</span>
<span class="token property">HEALTH_ENDPOINT</span> <span class="token punctuation">=</span> <span class="token string">"0.0.0.0:8080"</span></code></pre>


<h2>Set up TLS communication</h2>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>Documentation on TLS configuration for vault can be <a href="https://developer.hashicorp.com/vault/docs/configuration/listener/tcp">found on their website</a></p>
</div>
<h3>Add Vault's CA file(s) to the KMS provider</h3>
<p>To allow TLS encrypted communication with vault, Vault's CA (certificate authority) file(s) need to be installed in the KMS provider. This can be set in the values.yaml for the helm chart.</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">vault</span><span class="token punctuation">:</span>
  <span class="token key atrule">ca</span><span class="token punctuation">:</span>
    <span class="token comment"># full path to a specific CA file</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token string">"/path/to/ca.crt"</span>
    <span class="token comment"># full path to a directory containing CA file(s)</span>
    <span class="token key atrule">directory</span><span class="token punctuation">:</span> <span class="token string">"/path/to/ca/directory"</span></code></pre>
<p>If you have a single CA file for vault, you can set a specific path to it.</p>
<pre class="language-shell"><code class="language-shell">helm <span class="token function">install</span> vault-kms-provider <span class="token parameter variable">--set</span> <span class="token string">"vault.ca.file=/path/to/ca.crt"</span></code></pre>
<p>If you have more than one file, or would rather just point to a directory, you can also specify a directory path. All certificates in the directory path will be installed in the KMS provider.</p>
<pre class="language-shell"><code class="language-shell">helm <span class="token function">install</span> vault-kms-provider <span class="token parameter variable">--set</span> <span class="token string">"vault.ca.directory=/path/to/directory"</span></code></pre>
<h3>Mount Vault's CA files into the KMS provider</h3>
<p>In order for Vault's CA files to be installed, they must be present in the container, we can mount the CA file(s) by defining volumes and volumeMounts in our values.yaml.</p>
<p>The following are examples of how to mount Vault CA file(s) into the KMS provider.</p>
<h4>Secrets</h4>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token comment"># name of the volume, should match the volumeMount name</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certificate
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token comment"># The name of the secret that contains the Vault CA certificate(s)</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certs

<span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token comment"># Match with volume name</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certificate
    <span class="token comment"># path where the files will be in the KMS provider</span>
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs</code></pre>
<h4>Volumes</h4>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token comment"># name of the volume, should match the volumeMount name</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certificates
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token comment"># Path to the directory where the Vault CA certificate(s) are located on the host machine</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /path/to/host/certificates
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Directory

<span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token comment"># Match with volume name</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certificate
    <span class="token comment"># path where the files will be in the KMS provider</span>
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs</code></pre>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>A full list of <a href="https://kubernetes.io/docs/concepts/storage/volumes/">mount options and documentation</a> can be found on the Kubernetes website. Chose what works best for your use case.</p>
</div>


<h2>Set up Vault</h2>
<h3>Encryption</h3>
<p>Enable the transit gateway in Vault for encryption/decryption of data for Kubernetes.</p>
<pre class="language-shell"><code class="language-shell">vault secrets <span class="token builtin class-name">enable</span> transit</code></pre>
<p>Create a policy granting the permissions to the KMS provider to encrypt/decrypt data.</p>
<p><code>./transit.hcl</code></p>
<pre class="language-hcl"><code class="language-hcl">path <span class="token string">"/transit/decrypt/vault-kms-provider"</span> <span class="token punctuation">{</span>
  <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"update"</span>, <span class="token string">"create"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
path <span class="token string">"/transit/encrypt/vault-kms-provider"</span> <span class="token punctuation">{</span>
  <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"update"</span>, <span class="token string">"create"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
path <span class="token string">"/transit/keys/vault-kms-provider"</span> <span class="token punctuation">{</span>
  <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Add the policy to vault</p>
<pre class="language-shell"><code class="language-shell">vault policy <span class="token function">write</span> vault-kms-provider transit.hcl</code></pre>
<h3>Authentication</h3>
<p>Enable authentication via kubernetes</p>
<pre class="language-shell"><code class="language-shell">vault auth <span class="token builtin class-name">enable</span> kubernetes</code></pre>
<p>Set the host URL to the kubernetes API</p>
<pre class="language-shell"><code class="language-shell">vault <span class="token function">write</span> auth/kubernetes/config <span class="token assign-left variable">kubernetes_host</span><span class="token operator">=</span><span class="token string">"https://kubernetes.default.svc/"</span></code></pre>
<p>Create a role for the KMS provider's service account so that it can authenticate with vault.</p>
<pre class="language-shell"><code class="language-shell">vault <span class="token function">write</span> auth/kubernetes/role/vault-kms-provider <span class="token punctuation">\</span>
    <span class="token assign-left variable">bound_service_account_names</span><span class="token operator">=</span>vault-kms-provider <span class="token punctuation">\</span>
    <span class="token assign-left variable">bound_service_account_namespaces</span><span class="token operator">=</span>default <span class="token punctuation">\</span>
    <span class="token assign-left variable">audience</span><span class="token operator">=</span>vault <span class="token punctuation">\</span>
    <span class="token assign-left variable">token_policies</span><span class="token operator">=</span>vault-kms-provider <span class="token punctuation">\</span>
    <span class="token assign-left variable">ttl</span><span class="token operator">=</span>1h</code></pre>
<p>With vault configured you should be able to deploy the vault-kms-provider to kubernetes without error.</p>


</div>

    </div>
</div>
    </body>
</html>
