apiVersion: v1
kind: Secret
metadata:
  name: encryption-test-secret
data:
  hello: dmFsdWUtMg0KDQo=
---
apiVersion: v1
kind: Pod
metadata:
  name: "secret-encryption"
  annotations:
    "helm.sh/hook": test
spec:
  restartPolicy: Never
  volumes:
    - name: cert-volume
      hostPath:
        path: /tmp/certs
        type: Directory
  containers:
    - name: kubectl
      image: "docker.io/vaidik/etcd:latest"
      imagePullPolicy: "IfNotPresent"
      volumeMounts:
        - mountPath: /etc/ssl/certs
          name: cert-volume
          readOnly: true
      env:
        - name: ETCDCTL_ENDPOINTS
          value: https://127.0.0.1:2379
        - name: ETCDCTL_CACERT
          value: /tmp/certs/server.crt
        - name: ETCDCTL_CERT
          value: /tmp/certs/client.crt
        - name: ETCDCTL_KEY
          value: /tmp/certs/client.key
        - name: ETCD_DATA_DIR
          value: /var/lib/etcd
        - name: ETCDCTL_API
          value: "3"
      command:
        - /bin/sh
        - -c
        - >
          echo "starting";
          ls /etc/ssl/certs;
          export SECRET="$(etcdctl get /registry/secrets/default/encryption-test-secret | hexdump -C)";
          echo $SECRET;
          [[ "$SECRET" == *"hello"* ]] && exit 0 || exit 1;